<h1 id="android-plugin-development-guide">Android Plugin Development Guide</h1>

<p>This section provides details for how to implement native plugin code
on the Android platform. Before reading this, see the <a href="../../hybrid/plugins/index.html">Plugin Development Guide</a>
for an overview of the plugin’s structure and its common JavaScript
interface. This section continues to demonstrate the sample <em>echo</em>
plugin that communicates from the Cordova webview to the native
platform and back.  For another sample, see also the comments in
<a href="https://github.com/apache/cordova-android/blob/master/framework/src/org/apache/cordova/CordovaPlugin.java">CordovaPlugin.java</a>.</p>

<p>Android plugins are based on Cordova-Android, which is built from an
Android WebView with a native bridge. The native portion of an Android plugin
consists of at least one Java class that extends the <code class="language-plaintext highlighter-rouge">CordovaPlugin</code> class and
overrides one of its <code class="language-plaintext highlighter-rouge">execute</code> methods.</p>

<h2 id="plugin-class-mapping">Plugin Class Mapping</h2>

<p>The plugin’s JavaScript interface uses the <code class="language-plaintext highlighter-rouge">cordova.exec</code> method as
follows:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">exec</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">successFunction</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">failFunction</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">service</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">action</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">args</span><span class="o">&gt;</span><span class="p">]);</span>
</code></pre></div></div>
<p>This marshals a request from the WebView to the Android native side,
effectively calling the <code class="language-plaintext highlighter-rouge">action</code> method on the <code class="language-plaintext highlighter-rouge">service</code> class, with
additional arguments passed in the <code class="language-plaintext highlighter-rouge">args</code> array.</p>

<p>Whether you distribute a plugin as Java file or as a <em>jar</em> file of its
own, the plugin must be specified in your Cordova-Android
application’s <code class="language-plaintext highlighter-rouge">res/xml/config.xml</code> file. See Application Plugins for
more information on how to use the <code class="language-plaintext highlighter-rouge">plugin.xml</code> file to inject this
<code class="language-plaintext highlighter-rouge">feature</code> element:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;feature</span> <span class="na">name=</span><span class="s">"&lt;service_name&gt;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"android-package"</span> <span class="na">value=</span><span class="s">"&lt;full_name_including_namespace&gt;"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/feature&gt;</span>
</code></pre></div></div>

<p>The service name matches the one used in the JavaScript <code class="language-plaintext highlighter-rouge">exec</code> call.
The value is the Java class’s fully qualified namespace identifier.
Otherwise, the plugin may compile but still be unavailable to Cordova.</p>

<h2 id="plugin-initialization-and-lifetime">Plugin Initialization and Lifetime</h2>

<p>One instance of a plugin object is created for the life of each
<code class="language-plaintext highlighter-rouge">WebView</code>. Plugins are not instantiated until they are first
referenced by a call from JavaScript, unless <code class="language-plaintext highlighter-rouge">&lt;param&gt;</code> with an <code class="language-plaintext highlighter-rouge">onload</code>
<code class="language-plaintext highlighter-rouge">name</code> attribute is set to <code class="language-plaintext highlighter-rouge">"true"</code> in <code class="language-plaintext highlighter-rouge">config.xml</code>. For example,</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;feature</span> <span class="na">name=</span><span class="s">"Echo"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"android-package"</span> <span class="na">value=</span><span class="s">"&lt;full_name_including_namespace&gt;"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"onload"</span> <span class="na">value=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/feature&gt;</span>
</code></pre></div></div>

<p>Plugins should use the <code class="language-plaintext highlighter-rouge">initialize</code> method for their start-up logic.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="nc">CordovaInterface</span> <span class="n">cordova</span><span class="o">,</span> <span class="nc">CordovaWebView</span> <span class="n">webView</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="n">cordova</span><span class="o">,</span> <span class="n">webView</span><span class="o">);</span>
    <span class="c1">// your init code here</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Plugins also have access to Android lifecycle events and can handle them
by extending one of the provided methods (<code class="language-plaintext highlighter-rouge">onResume</code>, <code class="language-plaintext highlighter-rouge">onDestroy</code>, etc).
Plugins with long-running requests, background activity such as media playback,
listeners, or internal state should implement the <code class="language-plaintext highlighter-rouge">onReset()</code> method. It
executes when the <code class="language-plaintext highlighter-rouge">WebView</code> navigates to a new page or refreshes, which reloads
the JavaScript.</p>

<h2 id="writing-an-android-java-plugin">Writing an Android Java Plugin</h2>

<p>A JavaScript call fires off a plugin request to the native side, and
the corresponding Java plugin is mapped properly in the <code class="language-plaintext highlighter-rouge">config.xml</code>
file, but what does the final Android Java Plugin class look like?
Whatever is dispatched to the plugin with JavaScript’s <code class="language-plaintext highlighter-rouge">exec</code> function
is passed into the plugin class’s <code class="language-plaintext highlighter-rouge">execute</code> method. Most <code class="language-plaintext highlighter-rouge">execute</code>
implementations look like this:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">String</span> <span class="n">action</span><span class="o">,</span> <span class="nc">JSONArray</span> <span class="n">args</span><span class="o">,</span> <span class="nc">CallbackContext</span> <span class="n">callbackContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JSONException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="s">"beep"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">beep</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">callbackContext</span><span class="o">.</span><span class="na">success</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>  <span class="c1">// Returning false results in a "MethodNotFound" error.</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The JavaScript <code class="language-plaintext highlighter-rouge">exec</code> function’s <code class="language-plaintext highlighter-rouge">action</code> parameter corresponds to a
private class method to dispatch with optional parameters.</p>

<p>When catching exceptions and returning errors, it’s important for the
sake of clarity that errors returned to JavaScript match Java’s
exception names as much as possible.</p>

<h2 id="threading">Threading</h2>

<p>The plugin’s JavaScript does <em>not</em> run in the main thread of the
<code class="language-plaintext highlighter-rouge">WebView</code> interface; instead, it runs on the <code class="language-plaintext highlighter-rouge">WebCore</code> thread, as
does the <code class="language-plaintext highlighter-rouge">execute</code> method.  If you need to interact with the user
interface, you should use the <a href="http://developer.android.com/reference/android/app/Activity.html#runOnUiThread(java.lang.Runnable)">Activity’s <code class="language-plaintext highlighter-rouge">runOnUiThread</code></a>
method like so:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">String</span> <span class="n">action</span><span class="o">,</span> <span class="nc">JSONArray</span> <span class="n">args</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">CallbackContext</span> <span class="n">callbackContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JSONException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="s">"beep"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">cordova</span><span class="o">.</span><span class="na">getActivity</span><span class="o">().</span><span class="na">runOnUiThread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="o">...</span>
                <span class="n">callbackContext</span><span class="o">.</span><span class="na">success</span><span class="o">();</span> <span class="c1">// Thread-safe.</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>If you do not need to run on the UI thread, but do not wish to block the
<code class="language-plaintext highlighter-rouge">WebCore</code> thread either, you should execute your code using the Cordova
<a href="http://developer.android.com/reference/java/util/concurrent/ExecutorService.html"><code class="language-plaintext highlighter-rouge">ExecutorService</code></a> obtained with <code class="language-plaintext highlighter-rouge">cordova.getThreadPool()</code> like
so:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">String</span> <span class="n">action</span><span class="o">,</span> <span class="nc">JSONArray</span> <span class="n">args</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">CallbackContext</span> <span class="n">callbackContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JSONException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="s">"beep"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">long</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">cordova</span><span class="o">.</span><span class="na">getThreadPool</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="o">...</span>
                <span class="n">callbackContext</span><span class="o">.</span><span class="na">success</span><span class="o">();</span> <span class="c1">// Thread-safe.</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="adding-dependency-libraries">Adding Dependency Libraries</h2>

<p>If your Android plugin has extra dependencies, they must be listed in the
<code class="language-plaintext highlighter-rouge">plugin.xml</code> in one of two ways.</p>

<p>The preferred way is to use the <code class="language-plaintext highlighter-rouge">&lt;framework /&gt;</code> tag (see the
<a href="../../../plugin_ref/spec.html#framework">Plugin Specification</a> for more details).
Specifying libraries in this manner allows them to be resolved via Gradle’s
<a href="https://docs.gradle.org/current/userguide/dependency_management.html">Dependency Management logic</a>. This allows commonly used
libraries such as <em>gson</em>, <em>android-support-v4</em>, and <em>google-play-services</em> to be
used by multiple plugins without conflict.</p>

<p>The second option is to use the <code class="language-plaintext highlighter-rouge">&lt;lib-file /&gt;</code> tag to specify the location of
a jar file (see the <a href="../../../plugin_ref/spec.html#lib-file">Plugin Specification</a> for
more details). This approach should only be used if you are sure that no other
plugin will be depending on the library you are referencing (e.g. if the library
is specific to your plugin). Otherwise, you risk causing build errors for users
of your plugin if another plugin adds the same library. It is worth noting that
Cordova app developers are not necessarily native developers, so native platform
build errors can be especially frustrating.</p>

<h2 id="echo-android-plugin-example">Echo Android Plugin Example</h2>

<p>To match the JavaScript interface’s <em>echo</em> feature described in
Application Plugins, use the <code class="language-plaintext highlighter-rouge">plugin.xml</code> to inject a <code class="language-plaintext highlighter-rouge">feature</code>
specification to the local platform’s <code class="language-plaintext highlighter-rouge">config.xml</code> file:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;platform</span> <span class="na">name=</span><span class="s">"android"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;config-file</span> <span class="na">target=</span><span class="s">"config.xml"</span> <span class="na">parent=</span><span class="s">"/*"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;feature</span> <span class="na">name=</span><span class="s">"Echo"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"android-package"</span> <span class="na">value=</span><span class="s">"org.apache.cordova.plugin.Echo"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/feature&gt;</span>
    <span class="nt">&lt;/config-file&gt;</span>

    <span class="nt">&lt;source-file</span> <span class="na">src=</span><span class="s">"src/android/Echo.java"</span> <span class="na">target-dir=</span><span class="s">"src/org/apache/cordova/plugin"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/platform&gt;</span>
</code></pre></div></div>

<p>Then add the following to the <code class="language-plaintext highlighter-rouge">src/android/Echo.java</code> file:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.apache.cordova.plugin</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.cordova.CordovaPlugin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.cordova.CallbackContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.json.JSONArray</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.json.JSONException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.json.JSONObject</span><span class="o">;</span>

<span class="cm">/**
* This class echoes a string called from JavaScript.
*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Echo</span> <span class="kd">extends</span> <span class="nc">CordovaPlugin</span> <span class="o">{</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">String</span> <span class="n">action</span><span class="o">,</span> <span class="nc">JSONArray</span> <span class="n">args</span><span class="o">,</span> <span class="nc">CallbackContext</span> <span class="n">callbackContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JSONException</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">action</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"echo"</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">echo</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">callbackContext</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">echo</span><span class="o">(</span><span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">CallbackContext</span> <span class="n">callbackContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">message</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">callbackContext</span><span class="o">.</span><span class="na">success</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">callbackContext</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Expected one non-empty string argument."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The necessary imports at the top of the file extends the class from
<code class="language-plaintext highlighter-rouge">CordovaPlugin</code>, whose <code class="language-plaintext highlighter-rouge">execute()</code> method it overrides to receive
messages from <code class="language-plaintext highlighter-rouge">exec()</code>.  The <code class="language-plaintext highlighter-rouge">execute()</code> method first tests the value
of <code class="language-plaintext highlighter-rouge">action</code>, for which in this case there is only one valid <code class="language-plaintext highlighter-rouge">echo</code>
value.  Any other action returns <code class="language-plaintext highlighter-rouge">false</code> and results in an
<code class="language-plaintext highlighter-rouge">INVALID_ACTION</code> error, which translates to an error callback invoked
on the JavaScript side.</p>

<p>Next, the method retrieves the echo string using the <code class="language-plaintext highlighter-rouge">args</code> object’s
<code class="language-plaintext highlighter-rouge">getString</code> method, specifying the first parameter passed to the
method.  After the value is passed to a private <code class="language-plaintext highlighter-rouge">echo</code> method, it is
parameter-checked to make sure it is not <code class="language-plaintext highlighter-rouge">null</code> or an empty string, in
which case <code class="language-plaintext highlighter-rouge">callbackContext.error()</code> invokes JavaScript’s error
callback.  If the various checks pass, the <code class="language-plaintext highlighter-rouge">callbackContext.success()</code>
passes the original <code class="language-plaintext highlighter-rouge">message</code> string back to JavaScript’s success
callback as a parameter.</p>

<h2 id="android-integration">Android Integration</h2>

<p>Android features an <a href="http://developer.android.com/reference/android/content/Intent.html">Intent</a> system that allows processes to
communicate with each other.  Plugins have access to a
<code class="language-plaintext highlighter-rouge">CordovaInterface</code> object, which can access the Android <a href="http://developer.android.com/reference/android/app/Activity.html">Activity</a>
that runs the application.  This is the <a href="http://developer.android.com/reference/android/content/Context.html">Context</a> required to launch a
new Android <a href="http://developer.android.com/reference/android/content/Intent.html">Intent</a>.  The <code class="language-plaintext highlighter-rouge">CordovaInterface</code> allows plugins to start
an <a href="http://developer.android.com/reference/android/app/Activity.html">Activity</a> for a result, and to set the callback plugin for when
the <a href="http://developer.android.com/reference/android/content/Intent.html">Intent</a> returns to the application.</p>

<p>As of Cordova 2.0, Plugins can no longer directly access the
<a href="http://developer.android.com/reference/android/content/Context.html">Context</a>, and the legacy <code class="language-plaintext highlighter-rouge">ctx</code> member is deprecated. All <code class="language-plaintext highlighter-rouge">ctx</code>
methods exist on the <a href="http://developer.android.com/reference/android/content/Context.html">Context</a>, so both <code class="language-plaintext highlighter-rouge">getContext()</code> and
<code class="language-plaintext highlighter-rouge">getActivity()</code> can return the required object.</p>

<h2 id="android-permissions">Android Permissions</h2>

<p>Android permissions until recently have been handled at install-time instead
of runtime.  These permissions are required to be declared on an application that uses
the permissions, and these permissions need to be added to the Android Manifest.  This can be
accomplished by using the <code class="language-plaintext highlighter-rouge">config.xml</code> to inject these permissions in the <code class="language-plaintext highlighter-rouge">AndroidManifest.xml</code> file.
The example below uses the Contacts permission.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;config-file</span> <span class="na">target=</span><span class="s">"AndroidManifest.xml"</span> <span class="na">parent=</span><span class="s">"/*"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.READ_CONTACTS"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/config-file&gt;</span>
</code></pre></div></div>

<h3 id="runtime-permissions-cordova-android-500">Runtime Permissions (Cordova-Android 5.0.0+)</h3>

<p>Android 6.0 “Marshmallow” introduced a new permissions model where
the user can turn on and off permissions as necessary.  This means that
applications must handle these permission changes to be future-proof, which
was the focus of the Cordova-Android 5.0.0 release.</p>

<p>The permissions that need to be handled at runtime can be found in the Android Developer
documentation <a href="http://developer.android.com/guide/topics/security/permissions.html#perm-groups">here</a>.</p>

<p>As far as a plugin is concerned, the permission can be requested by calling the permission method, which signature is as follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cordova</span><span class="o">.</span><span class="na">requestPermission</span><span class="o">(</span><span class="nc">CordovaPlugin</span> <span class="n">plugin</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nc">String</span> <span class="n">permission</span><span class="o">);</span>
</code></pre></div></div>

<p>To cut down on verbosity, it’s standard practice to assign this to a local static variable:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">READ</span> <span class="o">=</span> <span class="nc">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">READ_CONTACTS</span><span class="o">;</span>
</code></pre></div></div>

<p>It is also standard practice to define the requestCode as follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">SEARCH_REQ_CODE</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</code></pre></div></div>

<p>Then, in the exec method, the permission should be checked:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="o">(</span><span class="n">cordova</span><span class="o">.</span><span class="na">hasPermission</span><span class="o">(</span><span class="no">READ</span><span class="o">))</span>
<span class="o">{</span>
    <span class="n">search</span><span class="o">(</span><span class="n">executeArgs</span><span class="o">);</span>
<span class="o">}</span>
<span class="k">else</span>
<span class="o">{</span>
    <span class="n">getReadPermission</span><span class="o">(</span><span class="no">SEARCH_REQ_CODE</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>In this case, we just call requestPermission:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">getReadPermission</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">)</span>
<span class="o">{</span>
    <span class="n">cordova</span><span class="o">.</span><span class="na">requestPermission</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">requestCode</span><span class="o">,</span> <span class="no">READ</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This will call the activity and cause a prompt to appear asking for the permission.  Once the user has the permission, the result must be handled with the <code class="language-plaintext highlighter-rouge">onRequestPermissionResult</code> method, which
every plugin should override.  An example of this can be found below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRequestPermissionResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">permissions</span><span class="o">,</span>
                                         <span class="kt">int</span><span class="o">[]</span> <span class="n">grantResults</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JSONException</span>
<span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="nl">r:</span><span class="n">grantResults</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_DENIED</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">callbackContext</span><span class="o">.</span><span class="na">sendPluginResult</span><span class="o">(</span><span class="k">new</span> <span class="nc">PluginResult</span><span class="o">(</span><span class="nc">PluginResult</span><span class="o">.</span><span class="na">Status</span><span class="o">.</span><span class="na">ERROR</span><span class="o">,</span> <span class="no">PERMISSION_DENIED_ERROR</span><span class="o">));</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">switch</span><span class="o">(</span><span class="n">requestCode</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">case</span> <span class="nl">SEARCH_REQ_CODE:</span>
            <span class="n">search</span><span class="o">(</span><span class="n">executeArgs</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">SAVE_REQ_CODE:</span>
            <span class="n">save</span><span class="o">(</span><span class="n">executeArgs</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">REMOVE_REQ_CODE:</span>
            <span class="n">remove</span><span class="o">(</span><span class="n">executeArgs</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The switch statement above would return from the prompt and depending on the requestCode that was passed in, it would call the method.  It should be noted that permission prompts may stack if the execution is not handled correctly, and that this should be avoided.</p>

<p>In addition to asking for permission for a single permission, it is also possible to request permissions for an entire group by defining the permissions array, as what is done with the Geolocation plugin:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="o">[]</span> <span class="n">permissions</span> <span class="o">=</span> <span class="o">{</span> <span class="nc">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_COARSE_LOCATION</span><span class="o">,</span> <span class="nc">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span> <span class="o">};</span>
</code></pre></div></div>

<p>Then when requesting the permission, all that needs to be done is the following:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cordova</span><span class="o">.</span><span class="na">requestPermissions</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">permissions</span><span class="o">);</span>
</code></pre></div></div>

<p>This requests the permissions specified in the array.  It’s a good idea to provide a publicly accessible permissions array since this can be used by plugins that use your plugin as a
dependency, although this is not required.</p>

<h2 id="debugging-android-plugins">Debugging Android Plugins</h2>

<p>Android debugging can be done with either Eclipse or Android Studio, although Android
studio is recommended.  Since Cordova-Android is currently used as a library project,
and plugins are supported as source code, it is possible to debug the Java code inside
a Cordova application just like a native Android application.</p>

<h2 id="launching-other-activities">Launching Other Activities</h2>

<p>There are special considerations to be made if your plugin launches an Activity
that pushes the Cordova <a href="http://developer.android.com/reference/android/app/Activity.html">Activity</a> to the background. The Android OS will destroy
Activities in the background if the device is running low on memory. In that
case, the <code class="language-plaintext highlighter-rouge">CordovaPlugin</code> instance will be destroyed as well. If your plugin is
waiting on a result from the <a href="http://developer.android.com/reference/android/app/Activity.html">Activity</a> it launched, a new instance of your plugin
will be created when the Cordova <a href="http://developer.android.com/reference/android/app/Activity.html">Activity</a> is brought back to the foreground and
the result is obtained. However, state for the plugin will not be automatically
saved or restored and the <code class="language-plaintext highlighter-rouge">CallbackContext</code> for the plugin will be lost. There are
two methods that your <code class="language-plaintext highlighter-rouge">CordovaPlugin</code> may implement to handle this situation:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Called when the Activity is being destroyed (e.g. if a plugin calls out to an
 * external Activity and the OS kills the CordovaActivity in the background).
 * The plugin should save its state in this method only if it is awaiting the
 * result of an external Activity and needs to preserve some information so as
 * to handle that result; onRestoreStateForActivityResult() will only be called
 * if the plugin is the recipient of an Activity result
 *
 * @return  Bundle containing the state of the plugin or null if state does not
 *          need to be saved
 */</span>
<span class="kd">public</span> <span class="nc">Bundle</span> <span class="nf">onSaveInstanceState</span><span class="o">()</span> <span class="o">{}</span>

<span class="cm">/**
 * Called when a plugin is the recipient of an Activity result after the
 * CordovaActivity has been destroyed. The Bundle will be the same as the one
 * the plugin returned in onSaveInstanceState()
 *
 * @param state             Bundle containing the state of the plugin
 * @param callbackContext   Replacement Context to return the plugin result to
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRestoreStateForActivityResult</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">state</span><span class="o">,</span> <span class="nc">CallbackContext</span> <span class="n">callbackContext</span><span class="o">)</span> <span class="o">{}</span>
</code></pre></div></div>

<p>It is important to note that the above methods should only be used if your
plugin launches an <a href="http://developer.android.com/reference/android/app/Activity.html">Activity</a> for a result and should only restore the state
necessary to handle that Activity result. The state of the plugin will <em>NOT</em> be
restored except in the case where an Activity result is obtained that your
plugin requested using the <code class="language-plaintext highlighter-rouge">CordovaInterface</code>’s <code class="language-plaintext highlighter-rouge">startActivityForResult()</code> method
and the Cordova Activity was destroyed by the OS while in the background.</p>

<p>As part of <code class="language-plaintext highlighter-rouge">onRestoreStateForActivityResult()</code>, your plugin will be passed a
replacement CallbackContext. It is important to realize that this
CallbackContext <em>IS NOT</em> the same one that was destroyed with the Activity. The
original callback is lost, and will not be fired in the javascript application.
Instead, this replacement <code class="language-plaintext highlighter-rouge">CallbackContext</code> will return the result as part of the
<a href="../../../cordova/events/events.html#resume"><code class="language-plaintext highlighter-rouge">resume</code></a> event that is fired when the application resumes. The
payload of the <a href="../../../cordova/events/events.html#resume"><code class="language-plaintext highlighter-rouge">resume</code></a> event follows this structure:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    action: "resume",
    pendingResult: {
        pluginServiceName: string,
        pluginStatus: string,
        result: any
    }
}
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pluginServiceName</code> will match the <a href="../../../plugin_ref/spec.html#name">name element</a> from your plugin.xml.</li>
  <li><code class="language-plaintext highlighter-rouge">pluginStatus</code> will be a String describing the status of the PluginResult
 passed to the CallbackContext. See PluginResult.java for the String values
 that correspond to plugin statuses</li>
  <li><code class="language-plaintext highlighter-rouge">result</code> will be whatever result the plugin passes to the CallbackContext
 (e.g. a String, a number, a JSON object, etc.)</li>
</ul>

<p>This <a href="../../../cordova/events/events.html#resume"><code class="language-plaintext highlighter-rouge">resume</code></a> payload will be passed to any callbacks that the javascript
application has registered for the <a href="../../../cordova/events/events.html#resume"><code class="language-plaintext highlighter-rouge">resume</code></a> event. This means that the result is
going <em>directly</em> to the Cordova application; your plugin will not have a chance
to process the result with javascript before the application receives it.
Consequently, you should strive to make the result returned by the native code
as complete as possible and not rely on any javascript callbacks when launching
activities.</p>

<p>Be sure to communicate how the Cordova application should interpret the result
they receive in the <a href="../../../cordova/events/events.html#resume"><code class="language-plaintext highlighter-rouge">resume</code></a> event. It is up to the Cordova application to
maintain their own state and remember what requests they made and what arguments
they provided if necessary. However, you should still clearly communicate the
meaning of <code class="language-plaintext highlighter-rouge">pluginStatus</code> values and what sort of data is being returned in the
<a href="../../../cordova/events/events.html#resume"><code class="language-plaintext highlighter-rouge">resume</code></a> field as part of your plugin’s API.</p>

<p>The complete sequence of events for launching an Activity is as follows</p>

<ol>
  <li>The Cordova application makes a call to your plugin</li>
  <li>Your plugin launches an Activity for a result</li>
  <li>The Android OS destroys the Cordova Activity and your plugin instance
    <ul>
      <li><em><code class="language-plaintext highlighter-rouge">onSaveInstanceState()</code> is called</em></li>
    </ul>
  </li>
  <li>The user interacts with your Activity and the Activity finishes</li>
  <li>The Cordova Activity is recreated and the Activity result is received
    <ul>
      <li><em><code class="language-plaintext highlighter-rouge">onRestoreStateForActivityResult()</code> is called</em></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">onActivityResult()</code> is called and your plugin passes a result to the new
 CallbackContext</li>
  <li>The <a href="../../../cordova/events/events.html#resume"><code class="language-plaintext highlighter-rouge">resume</code></a> event is fired and received by the Cordova application</li>
</ol>

<p>Android provides a developer setting for debugging Activity destruction on low
memory. Enable the “Don’t keep activities” setting in the Developer Options menu
on your device or emulator to simulate low memory scenarios. If your plugin
launches external activities, you should always do some testing with this
setting enabled to ensure that you are properly handling low memory scenarios.</p>

