---
---

###############################################################################
# WARNING
###############################################################################
# Only modify this file if you know what you're doing. This file has
# the potential to make pages become PERMANENTLY UNREACHABLE. If in
# doubt, refer to these links:
#
# RewriteRule       - https://httpd.apache.org/docs/current/mod/mod_rewrite.html
# RewriteRule flags - https://httpd.apache.org/docs/current/rewrite/flags.html
# .htaccess tester  - https://htaccess.madewithlove.be/
#
# And remember: three-oh-ONE (301) menas you get ONE chance to get it right;
#               three-oh-TWO (302) means you get TWO chances.
###############################################################################

# Set Error Pages
ErrorDocument 404 {{site.baseurl}}/404.html

# Turn Off Automatic Directory Indices
Options -Indexes

# Turn On Redirection
Options +FollowSymLinks
RewriteEngine on

# From Cordova PMC Member raphinesse
# Redirect to HTTPS (https://s.apache.org/An8s)
# If we receive a forwarded http request from a proxy or
# just a plain old http request directly from the client
RewriteCond %{HTTP:X-Forwarded-Proto} =http [OR]
RewriteCond %{HTTP:X-Forwarded-Proto} =""
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Do Not Rewrite Archive
RewriteRule ^archive/ - [L]

# Redirect language docs with no version or subpath defined to English latest docs
#   /docs       → /docs/en/latest
#   /docs/en    → /docs/en/latest
#   /docs/ja    → /docs/en/latest
#   /docs/zh-tw → /docs/en/latest
RewriteRule ^docs(?:/[a-z]{2}(?:-[a-z]{2})?)?/?$ \
    {{site.baseurl}}/docs/en/latest/ [R=301,L]

# Redirect edge and dev docs to latest docs. There is no more dev docs.
#   /docs/*/edge/* → /docs/en/latest/*
#   /docs/*/dev/*  → /docs/en/latest/*
RewriteRule ^docs/([a-z]{2}(?:-[a-z]{2})?)/(edge|dev)(/.*)?$ \
    {{site.baseurl}}/docs/en/latest$3 [R=301,L]

# 301 (PERMANENT):
#
#     docs/*/XX/* -> archive/docs/*/YY/*
{% for redirect in site.data.redirects.version-renames %}
RewriteRule ^docs/([a-z]{2}(?:-[a-z]{2})?)/{{redirect[0]}}(/.*)?$ \
    {{site.baseurl}}/archive/docs/$1/{{redirect[1]}}$2 [R=301,L]
{% endfor %}
# 302 (TEMPORARY):
#
#     docs/XX/* -> docs/YY/*
#
{% for redirect in site.data.redirects.language-renames %}
RewriteRule ^docs/{{redirect[0]}}/([0-9]+(\.[0-9x]+)+(-[0-9.]+)?)(/.*)?$ \
    {{site.baseurl}}/archive/docs/{{redirect[1]}}/$1$4 [R=302,L]
{% endfor %}
# 301 (PERMANENT):
#
#     old docs pages -> new docs pages (global)
#
# NOTE:
#       The first part of the path (i.e. the ".*") is thrown away and replaced
#       by site.baseurl. It is thrown away because there is no RewriteCond to
#       control whether the rewrite happens to a URI or a local file path
#       (when Apache is locating the local file to serve).
{% for redirect in site.data.redirects.docs-global %}
RewriteRule ^docs/([a-z]{2}(?:-[a-z]{2})?)/([0-9]+(\.[0-9x]+)+(-[0-9.]+)?)/{{redirect[0]}}$ \
    {{site.baseurl}}/archive/docs/$1/$2/{{redirect[1]}} [NE,R=301,L]
RewriteRule ^docs/([a-z]{2}(?:-[a-z]{2})?)/{{redirect[0]}}$ \
    {{site.baseurl}}/docs/$1/{{redirect[1]}} [NE,R=301,L]
{% endfor %}
# 301 (PERMANENT):
#
#     old docs pages -> new docs pages (version-specific)
#
{% for redirect in site.data.redirects.docs %}
RewriteRule ^docs/([a-z]{2}(?:-[a-z]{2})?)/{{redirect[0]}}$ \
    {{site.baseurl}}/docs/$1/{{redirect[1]}} [NE,R=301,L]
{% endfor %}
# 301 (PERMANENT):
#
#     old pages -> new pages
#
{% for redirect in site.data.redirects.general %}
RewriteRule ^.*/{{redirect[0]}}$ {{site.baseurl}}/{{redirect[1]}} [NE,R=301,L]
{% endfor %}
# ALL previous language+versioned docs will redirect to archive
# The key part of the expression is that all versions docs must contain one dot after a number.
RewriteRule ^docs/([a-z]{2}(?:-[a-z]{2})?)/([0-9]+(\.[0-9x]+)+(-[0-9.]+)?)(/.*)?$ \
    {{site.baseurl}}/archive/docs/$1/$2$5 [R=301,L]
